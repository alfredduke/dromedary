{
  "Description":"Launch nested CloudFormation stack to provision all Dromedary resources",
  "AWSTemplateFormatVersion":"2010-09-09",
  "Parameters":{
    "DromedaryRepo":{
      "Type":"String",
      "Description":"The Github https address to the public dromedary repository.",
      "Default":"https://github.com/stelligent/dromedary.git"
    },
    "Branch":{
      "Type":"String",
      "Description":"The Github branch the public dromedary repository.",
      "Default":"master"
    },
    "ProdHostedZone":{
      "Type":"String",
      "Default":"Nothing.For.Now",
      "Description":"Route53 Hosted Zone (e.g. PRODHOST.HOSTED.ZONE)",
      "AllowedPattern":"^.*?\\..*?\\..*$"
    },
    "AliveDuration":{
      "Type":"String",
      "Description":"Duration to keep demo deployment active. (e.g. 4h, 3h, 30m, etc)",
      "Default":"4h",
      "AllowedPattern":"[0-9]+(m|h)"
    },
    "GitHubToken":{
      "NoEcho":"true",
      "Type":"String",
      "Description":"Secret. OAuthToken with access to Repo. The default is invalid and used for example purposes. Go to https://github.com/settings/tokens",
      "Default":"4a189a34546435225614563ebd44a1531a4657af"
    },
    "GitHubUser":{
      "Type":"String",
      "Description":"GitHub UserName. This username must have access to the GitHubToken.",
      "Default":"stelligent"
    },
    "Ec2SshKeyName":{
      "Type":"String",
      "Description":"The ec2 key name to use for ssh access to the bootstrapping instance."
    },
    "JobConfigsTarball":{
      "Type":"String",
      "Description":"The S3 key for the S3Bucket.",
      "Default":"pmd1446-jenkins/jenkins-job-configs-1453319706.tgz"
    }
  },
  "Resources":{
    "DynamoDBStack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":"https://s3.amazonaws.com/stelligent-training-public/public/dynamodb.json",
        "TimeoutInMinutes":"60"
      }
    },
    "VPCStack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":"https://s3.amazonaws.com/stelligent-training-public/public/vpc.json",
        "TimeoutInMinutes":"60"
      }
    },
    "IAMStack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":"https://s3.amazonaws.com/stelligent-training-public/public/iam.json",
        "TimeoutInMinutes":"60"
      }
    },
    "JenkinsStack":{
      "Type":"AWS::CloudFormation::Stack",
      "DependsOn":[
        "VPCStack",
        "IAMStack"
      ],
      "Properties":{
        "TemplateURL":"https://s3.amazonaws.com/stelligent-training-public/public/jenkins-instance.json",
        "TimeoutInMinutes":"60",
        "Parameters":{
          "Ec2Key":{
            "Ref":"Ec2SshKeyName"
          },
          "SubnetId":{
            "Fn::GetAtt":[
              "VPCStack",
              "Outputs.SubnetId"
            ]
          },
          "VPC":{
            "Fn::GetAtt":[
              "VPCStack",
              "Outputs.VPC"
            ]
          },
          "CfnInitRole":{
            "Fn::GetAtt":[
              "IAMStack",
              "Outputs.InstanceRole"
            ]
          },
          "InstanceProfile":{
            "Fn::GetAtt":[
              "IAMStack",
              "Outputs.InstanceProfile"
            ]
          },
          "JobConfigsTarball":{
            "Ref":"JobConfigsTarball"
          },
          "S3Bucket":{
            "Fn::Join":[
              "",
              [
                "dromedary-",
                {
                  "Ref":"AWS::AccountId"
                }
              ]
            ]
          }
        }
      }
    }
  },
  "Outputs":{
    "StackName":{
      "Value":{
        "Ref":"AWS::StackName"
      }
    },
    "VPC":{
      "Value":{
        "Fn::GetAtt":[
          "VPCStack",
          "Outputs.VPC"
        ]
      }
    },
    "SubnetId":{
      "Value":{
        "Fn::GetAtt":[
          "VPCStack",
          "Outputs.SubnetId"
        ]
      }
    },
    "CfnInitRole":{
      "Value":{
        "Fn::GetAtt":[
          "IAMStack",
          "Outputs.InstanceRole"
        ]
      }
    },
    "InstanceProfile":{
      "Value":{
        "Fn::GetAtt":[
          "IAMStack",
          "Outputs.InstanceProfile"
        ]
      }
    },
    "CodeDeployServiceRoleARN":{
      "Value":{
        "Fn::GetAtt":[
          "IAMStack",
          "Outputs.CodeDeployServiceRoleARN"
        ]
      }
    },
    "CodePipelineTrustRoleARN":{
      "Value":{
        "Fn::GetAtt":[
          "IAMStack",
          "Outputs.CodePipelineTrustRoleARN"
        ]
      }
    },
    "S3Bucket":{
      "Value":{
        "Fn::Join":[
          "",
          [
            "dromedary-",
            {
              "Ref":"AWS::AccountId"
            }
          ]
        ]
      }
    }
  }
}